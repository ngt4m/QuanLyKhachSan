@model QuanLyKhachSan.ViewModels.Payment.PaymentViewModel

@{
    ViewData["Title"] = "Thanh Toán";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">Thanh Toán</h3>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
                    }
                    @if (TempData["InfoMessage"] != null)
                    {
                        <div class="alert alert-info">@TempData["InfoMessage"]</div>
                    }

                    <div class="row">
                        <div class="col-md-6">
                            <h5>Tóm Tắt Đặt Phòng</h5>
                            <div class="border p-3 rounded">
                                <p><strong>Mã Đặt Phòng:</strong> #@Model.BookingId</p>
                                <p><strong>Phòng:</strong> @Model.RoomName</p>
                                <p><strong>Nhận phòng:</strong> @Model.CheckInDate.ToString("dd/MM/yyyy")</p>
                                <p><strong>Trả phòng:</strong> @Model.CheckOutDate.ToString("dd/MM/yyyy")</p>
                                <p><strong>Số khách:</strong> @Model.NumberOfGuests</p>
                                <hr>
                                <h5 class="text-success">Tổng tiền: $@Model.TotalPrice.ToString("N2")</h5>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Phương Thức Thanh Toán</h5>
                            <form method="post" asp-controller="Payments" asp-action="ProcessPayment" id="paymentForm" novalidate>
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="bookingId" value="@Model.BookingId" />

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="creditCard" value="Credit Card" checked>
                                    <label class="form-check-label" for="creditCard">
                                        <i class="fas fa-credit-card me-2"></i>Thẻ Tín Dụng/Ghi Nợ
                                    </label>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="paypal" value="PayPal">
                                    <label class="form-check-label" for="paypal">
                                        <i class="fab fa-paypal me-2"></i>PayPal
                                    </label>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="bankTransfer" value="Bank Transfer">
                                    <label class="form-check-label" for="bankTransfer">
                                        <i class="fas fa-university me-2"></i>Chuyển Khoản Ngân Hàng
                                    </label>
                                </div>

                                <!-- Form Thẻ Tín Dụng -->
                                <div id="creditCardForm" class="payment-method-form">
                                    <div class="mb-3">
                                        <label class="form-label">Số Thẻ</label>
                                        <input type="text" class="form-control" placeholder="1234 5678 9012 3456"
                                               pattern="[0-9]{16}" title="Vui lòng nhập số thẻ 16 chữ số hợp lệ" >
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Ngày Hết Hạn</label>
                                                <input type="text" class="form-control" placeholder="MM/YY"
                                                       pattern="(0[1-9]|1[0-2])\/[0-9]{2}" title="Vui lòng nhập ngày hết hạn hợp lệ (MM/YY)" >
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">CVV</label>
                                                <input type="text" class="form-control" placeholder="123"
                                                       pattern="[0-9]{3,4}" title="Vui lòng nhập CVV hợp lệ" >
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Tên Chủ Thẻ</label>
                                        <input type="text" class="form-control" placeholder="Nguyễn Văn A" >
                                    </div>
                                </div>

                                <!-- Form PayPal -->
                                <div id="paypalForm" class="payment-method-form" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fab fa-paypal me-2"></i>Thanh Toán PayPal</h6>
                                        <p class="mb-2">Bạn sẽ được chuyển hướng đến PayPal để hoàn tất thanh toán.</p>
                                        <p class="mb-0">Số tiền: <strong>$@Model.TotalPrice.ToString("N2")</strong></p>
                                    </div>
                                    <div class="text-center">
                                        <i class="fab fa-paypal fa-3x text-primary mb-3"></i>
                                        <p>Nhấp "Thanh Toán Ngay" để chuyển đến PayPal</p>
                                    </div>
                                </div>

                                <!-- Form Chuyển Khoản Ngân Hàng -->
                                <div id="bankTransferForm" class="payment-method-form" style="display: none;">
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-university me-2"></i>Thông Tin Chuyển Khoản</h6>
                                        <p class="mb-1">Vui lòng chuyển khoản chính xác số tiền vào tài khoản ngân hàng của chúng tôi:</p>
                                    </div>

                                    <div class="bank-info p-3 border rounded mb-3">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Ngân hàng:</strong><br>Vietcombank</p>
                                                <p><strong>Tên tài khoản:</strong><br>CÔNG TY KHÁCH SẠN LUXURY</p>
                                                <p><strong>Số tài khoản:</strong><br>1234 5678 9012 3456</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Chi nhánh:</strong><br>Thành phố Hà Nội</p>
                                                <p><strong>Mã giao dịch:</strong><br>ABCEFGH</p>
                                                <p><strong>Số tiền:</strong><br><span class="text-success fw-bold">$@Model.TotalPrice.ToString("N2")</span></p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="text-center mb-3">
                                        <div class="border p-3 d-inline-block">
                                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=LUXURYHOTEL@@Model.BookingId@@@Model.TotalPrice"
                                                 alt="Mã QR" class="img-fluid">
                                            <p class="mt-2 small text-muted">Quét mã QR để chuyển khoản nhanh</p>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Nội Dung Chuyển Khoản</label>
                                        <input type="text" class="form-control" placeholder="Tên của bạn hoặc mã đặt phòng" >
                                        <small class="form-text text-muted">Vui lòng ghi rõ Mã Đặt Phòng #@Model.BookingId trong nội dung chuyển khoản</small>
                                    </div>

                                    <div class="alert alert-info">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            Đặt phòng của bạn sẽ được xác nhận sau khi chúng tôi nhận được thanh toán.
                                            Quá trình xử lý có thể mất 1-2 ngày làm việc.
                                        </small>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fas fa-lock me-2"></i>Thanh Toán Ngay
                                    </button>

                                    <a href="@Url.Action("Details", "Bookings", new { id = Model.BookingId })"
                                       class="btn btn-outline-secondary">Hủy Thanh Toán</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
@section Scripts {
    <script>
        // Hiển thị/ẩn form thanh toán dựa trên lựa chọn
        function showPaymentForm() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

            // Ẩn tất cả form
            document.querySelectorAll('.payment-method-form').forEach(form => {
                form.style.display = 'none';
            });

            // Hiển thị form được chọn
            if (selectedMethod === 'Credit Card') {
                document.getElementById('creditCardForm').style.display = 'block';
            } else if (selectedMethod === 'PayPal') {
                document.getElementById('paypalForm').style.display = 'block';
            } else if (selectedMethod === 'Bank Transfer') {
                document.getElementById('bankTransferForm').style.display = 'block';
            }
        }

        // Thêm event listeners cho radio buttons
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', showPaymentForm);
        });

        // Trạng thái ban đầu
        showPaymentForm();

        // Xác thực form - ĐÃ SỬA ĐỂ TRÁNH LỖI
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            // LUÔN ngăn default trước để xử lý bằng JS
            e.preventDefault();

            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            let isValid = true;
            let errorMessage = '';

            // VALIDATION CHO THẺ TÍN DỤNG
            if (paymentMethod === 'Credit Card') {
                // SỬA: Dùng selector chính xác hơn
                const cardNumber = document.querySelector('#creditCardForm input[name="cardNumber"]') ||
                                   document.querySelector('#creditCardForm input[placeholder*="1234"]');
                const expiryDate = document.querySelector('#creditCardForm input[name="expiryDate"]') ||
                                   document.querySelector('#creditCardForm input[placeholder*="MM/YY"]');
                const cvv = document.querySelector('#creditCardForm input[name="cvv"]') ||
                            document.querySelector('#creditCardForm input[placeholder*="123"]');
                const cardHolder = document.querySelector('#creditCardForm input[name="cardHolder"]') ||
                                   document.querySelector('#creditCardForm input[placeholder*="Nguyễn"]');

                if (!cardNumber || !cardNumber.value ||
                    !expiryDate || !expiryDate.value ||
                    !cvv || !cvv.value ||
                    !cardHolder || !cardHolder.value) {
                    isValid = false;
                    errorMessage = 'Vui lòng điền đầy đủ thông tin thẻ tín dụng.';
                }
                // Thêm validation định dạng nếu muốn
                else if (cardNumber.value && !/^\d{16}$/.test(cardNumber.value.replace(/\s/g, ''))) {
                    isValid = false;
                    errorMessage = 'Số thẻ phải có đúng 16 chữ số.';
                }
            }
            // VALIDATION CHO CHUYỂN KHOẢN NGÂN HÀNG
            else if (paymentMethod === 'Bank Transfer') {
                const transferRef = document.querySelector('#bankTransferForm input[name="transferReference"]') ||
                                    document.querySelector('#bankTransferForm input[placeholder*="Tên của bạn"]');

                if (!transferRef || !transferRef.value) {
                    isValid = false;
                    errorMessage = 'Vui lòng nhập nội dung chuyển khoản.';
                }
            }
            // PAYPAL: không cần validation

            if (!isValid) {
                alert(errorMessage);
                return false;
            }

            // Nếu hợp lệ, hiển thị loading và submit form
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Đang xử lý...';

            // Submit form SAU KHI đã validate
            setTimeout(() => {
                this.submit();
            }, 100);

            return true;
        });
    </script>

    <style>
        .payment-method-form {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }

        .bank-info {
            background-color: white;
        }

        .form-check-input:checked {
            background-color: #198754;
            border-color: #198754;
        }
    </style>
}

    <style>
        .payment-method-form {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }

        .bank-info {
            background-color: white;
        }

        .form-check-input:checked {
            background-color: #198754;
            border-color: #198754;
        }
    </style>
}