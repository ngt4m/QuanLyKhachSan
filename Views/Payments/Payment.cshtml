@model QuanLyKhachSan.ViewModels.Payment.PaymentViewModel

@{
    ViewData["Title"] = "Payment";
}

<div class="container mt-5">
    <div class="row justify-content-center">
        <div class="col-md-8">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h3 class="mb-0">Payment</h3>
                </div>
                <div class="card-body">
                    @if (TempData["ErrorMessage"] != null)
                    {
                        <div class="alert alert-danger">@TempData["ErrorMessage"]</div>
                    }
                    @if (TempData["InfoMessage"] != null)
                    {
                        <div class="alert alert-info">@TempData["InfoMessage"]</div>
                    }

                    <div class="row">
                        <div class="col-md-6">
                            <h5>Booking Summary</h5>
                            <div class="border p-3 rounded">
                                <p><strong>Booking ID:</strong> #@Model.BookingId</p>
                                <p><strong>Room:</strong> @Model.RoomName</p>
                                <p><strong>Check-in:</strong> @Model.CheckInDate.ToString("MMM dd, yyyy")</p>
                                <p><strong>Check-out:</strong> @Model.CheckOutDate.ToString("MMM dd, yyyy")</p>
                                <p><strong>Guests:</strong> @Model.NumberOfGuests</p>
                                <hr>
                                <h5 class="text-success">Total: $@Model.TotalPrice.ToString("N2")</h5>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h5>Payment Method</h5>
                            <form method="post" asp-controller="Payments" asp-action="ProcessPayment" id="paymentForm">
                                @Html.AntiForgeryToken()
                                <input type="hidden" name="bookingId" value="@Model.BookingId" />

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="creditCard" value="Credit Card" checked>
                                    <label class="form-check-label" for="creditCard">
                                        <i class="fas fa-credit-card me-2"></i>Credit Card
                                    </label>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="paypal" value="PayPal">
                                    <label class="form-check-label" for="paypal">
                                        <i class="fab fa-paypal me-2"></i>PayPal
                                    </label>
                                </div>

                                <div class="form-check mb-3">
                                    <input class="form-check-input" type="radio" name="paymentMethod"
                                           id="bankTransfer" value="Bank Transfer">
                                    <label class="form-check-label" for="bankTransfer">
                                        <i class="fas fa-university me-2"></i>Bank Transfer
                                    </label>
                                </div>

                                <!-- Credit Card Form -->
                                <div id="creditCardForm" class="payment-method-form">
                                    <div class="mb-3">
                                        <label class="form-label">Card Number</label>
                                        <input type="text" class="form-control" placeholder="1234 5678 9012 3456"
                                               pattern="[0-9]{16}" title="Please enter a valid 16-digit card number" required>
                                    </div>
                                    <div class="row">
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">Expiry Date</label>
                                                <input type="text" class="form-control" placeholder="MM/YY"
                                                       pattern="(0[1-9]|1[0-2])\/[0-9]{2}" title="Please enter a valid expiry date (MM/YY)" required>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <div class="mb-3">
                                                <label class="form-label">CVV</label>
                                                <input type="text" class="form-control" placeholder="123"
                                                       pattern="[0-9]{3,4}" title="Please enter a valid CVV" required>
                                            </div>
                                        </div>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">Card Holder Name</label>
                                        <input type="text" class="form-control" placeholder="John Doe" required>
                                    </div>
                                </div>

                                <!-- PayPal Form -->
                                <div id="paypalForm" class="payment-method-form" style="display: none;">
                                    <div class="alert alert-info">
                                        <h6><i class="fab fa-paypal me-2"></i>PayPal Payment</h6>
                                        <p class="mb-2">You will be redirected to PayPal to complete your payment.</p>
                                        <p class="mb-0">Amount: <strong>$@Model.TotalPrice.ToString("N2")</strong></p>
                                    </div>
                                    <div class="text-center">
                                        <i class="fab fa-paypal fa-3x text-primary mb-3"></i>
                                        <p>Click "Pay Now" to proceed to PayPal</p>
                                    </div>
                                </div>

                                <!-- Bank Transfer Form -->
                                <div id="bankTransferForm" class="payment-method-form" style="display: none;">
                                    <div class="alert alert-warning">
                                        <h6><i class="fas fa-university me-2"></i>Bank Transfer Information</h6>
                                        <p class="mb-1">Please transfer the exact amount to our bank account:</p>
                                    </div>

                                    <div class="bank-info p-3 border rounded mb-3">
                                        <div class="row">
                                            <div class="col-md-6">
                                                <p><strong>Bank Name:</strong><br>Vietcombank</p>
                                                <p><strong>Account Name:</strong><br>LUXURY HOTEL COMPANY</p>
                                                <p><strong>Account Number:</strong><br>1234 5678 9012 3456</p>
                                            </div>
                                            <div class="col-md-6">
                                                <p><strong>Branch:</strong><br>Ho Chi Minh City</p>
                                                <p><strong>SWIFT Code:</strong><br>BFTVVNVX</p>
                                                <p><strong>Amount:</strong><br><span class="text-success fw-bold">$@Model.TotalPrice.ToString("N2")</span></p>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="text-center mb-3">
                                        <div class="border p-3 d-inline-block">
                                            <img src="https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=LUXURYHOTEL@@Model.BookingId@@@Model.TotalPrice"
                                                 alt="QR Code" class="img-fluid">
                                            <p class="mt-2 small text-muted">Scan QR code for quick transfer</p>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label">Transfer Reference</label>
                                        <input type="text" class="form-control" placeholder="Your name or booking ID" required>
                                        <small class="form-text text-muted">Please include Booking #@Model.BookingId in transfer description</small>
                                    </div>

                                    <div class="alert alert-info">
                                        <small>
                                            <i class="fas fa-info-circle me-1"></i>
                                            Your booking will be confirmed once we receive the payment.
                                            Processing may take 1-2 business days.
                                        </small>
                                    </div>
                                </div>

                                <div class="d-grid gap-2">
                                    <button type="submit" class="btn btn-success btn-lg">
                                        <i class="fas fa-lock me-2"></i>Pay Now
                                    </button>

                                    <a href="@Url.Action("Details", "Bookings", new { id = Model.BookingId })"
                                       class="btn btn-outline-secondary">Cancel Payment</a>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Show/hide payment forms based on selection
        function showPaymentForm() {
            const selectedMethod = document.querySelector('input[name="paymentMethod"]:checked').value;

            // Hide all forms
            document.querySelectorAll('.payment-method-form').forEach(form => {
                form.style.display = 'none';
            });

            // Show selected form
            if (selectedMethod === 'Credit Card') {
                document.getElementById('creditCardForm').style.display = 'block';
            } else if (selectedMethod === 'PayPal') {
                document.getElementById('paypalForm').style.display = 'block';
            } else if (selectedMethod === 'Bank Transfer') {
                document.getElementById('bankTransferForm').style.display = 'block';
            }
        }

        // Add event listeners to radio buttons
        document.querySelectorAll('input[name="paymentMethod"]').forEach(radio => {
            radio.addEventListener('change', showPaymentForm);
        });

        // Initial state
        showPaymentForm();

        // Form validation
        document.getElementById('paymentForm').addEventListener('submit', function(e) {
            const paymentMethod = document.querySelector('input[name="paymentMethod"]:checked').value;
            let isValid = true;

            if (paymentMethod === 'Credit Card') {
                const cardNumber = document.querySelector('#creditCardForm input[placeholder="1234 5678 9012 3456"]');
                const expiryDate = document.querySelector('#creditCardForm input[placeholder="MM/YY"]');
                const cvv = document.querySelector('#creditCardForm input[placeholder="123"]');
                const cardHolder = document.querySelector('#creditCardForm input[placeholder="John Doe"]');

                if (!cardNumber.value || !expiryDate.value || !cvv.value || !cardHolder.value) {
                    e.preventDefault();
                    alert('Please fill in all credit card details.');
                    isValid = false;
                }
            } else if (paymentMethod === 'Bank Transfer') {
                const transferRef = document.querySelector('#bankTransferForm input[placeholder="Your name or booking ID"]');
                if (!transferRef.value) {
                    e.preventDefault();
                    alert('Please enter a transfer reference.');
                    isValid = false;
                }
            }

            if (isValid) {
                // Show loading state
                const submitBtn = this.querySelector('button[type="submit"]');
                submitBtn.disabled = true;
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Processing...';
            }

            return isValid;
        });
    </script>

    <style>
        .payment-method-form {
            border: 1px solid #dee2e6;
            border-radius: 0.375rem;
            padding: 1rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }

        .bank-info {
            background-color: white;
        }

        .form-check-input:checked {
            background-color: #198754;
            border-color: #198754;
        }
    </style>
}